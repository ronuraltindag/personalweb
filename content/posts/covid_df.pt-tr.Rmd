---
title: "Koronavirüs (COVID-19)"
author: "Onur Altindag"
date: "2020-04-05"
output: md_document
---

```{r setup, include=FALSE}
need <- c('glue', 'dplyr','readxl', 'haven', 'ggplot2', 'utils','httr', 'viridis', 'ggsci',
          'tidyr','zoo','ggrepel','ggthemes','kableExtra','gganimate','ftplottools')

have <- need %in% rownames(installed.packages()) 
if(any(!have)) install.packages(need[!have]) 
invisible(lapply(need, library, character.only=T)) 
```

## Türkiye Koronavirüs (COVID-19) Salgını: Karşılaştırmalı bir perspektif

### Son Güncelleme: 5 Nisan 2020 

Neredeyse tüm dünyayı bir karantina alanına çeviren COVID-19 ile ilgili gelişmeleri Türkiye özelinde  karşılaştırmalı olarak takip edebilmek için aşağıdaki grafiği oluşturup vakit buldukça güncellemeye karar verdim. Bu grafikte Türkiye'de gözlemlenen ve Sağlık Bakanlığı tarafından temin edilen COVID-19 bağlantılı ölüm sayısını İtalya, İspanya ve Güney Kore ile karşılaştırıyorum.  Yatay eksen ilk gözlenen COVID-19 ölümü sonrasında geçen gün sayısını, dikey eksen ise logaritmik ölçekte toplam ölüm sayısını gösteriyor. Grafik ile ilgili veriye ve programa [github](https://github.com/ronuraltindag/personalweb/tree/master/content/posts) sayfamdan ulaşabilirsiniz.      



```{r read.df, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'hide'}

#these libraries need to be loaded


#download the dataset from the ECDC website to a local temporary file
GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))

#read the Dataset sheet into “R”. The dataset will be called "data".
df1<- read.csv(tf)

new.date <- "05/05/2020"
new.cases <- 3135 
new.deaths <- 73


tr.update <- df1 %>%
  filter(countryterritoryCode=="TUR") %>%
  filter(row_number()==1) %>%
  mutate(dateRep=new.date, cases=new.cases, deaths=new.deaths) 
  

df2 <- rbind(df1,tr.update) %>%
  mutate(cal.date = as.Date(paste(year,month,day,sep="-"))) %>%
  filter(countriesAndTerritories=='Turkey' | 
         countriesAndTerritories=='Italy'  | 
         countriesAndTerritories=='Spain'  |
         countriesAndTerritories=='South_Korea' | 
         countryterritoryCode=='USA' | 
         countryterritoryCode=='GBR' | 
         countryterritoryCode=='DEU'   ) %>%
  arrange(countriesAndTerritories, cal.date) %>%
  group_by(countriesAndTerritories) %>%
  mutate(cdeaths = cumsum(deaths), days.since = rank(cal.date, ties.method = "first")) %>%
  filter(cdeaths>0) %>%
  mutate(days.since = rank(cal.date, ties.method = "first")) 

anim.s <- function(n){
  df <- df2 %>%
    filter(days.since<n) %>%
    mutate(c.days.since=n)
  
return(df)    
} 

max.n <- max(df2$days.since)
  
df3 <- do.call(rbind.data.frame,lapply(2:max.n, anim.s)) 

df4 <- df1 %>%
  mutate(cal.date = as.Date(paste(year,month,day,sep="-"))) %>%
  arrange(countriesAndTerritories, cal.date) %>%
  group_by(countriesAndTerritories) %>%
  mutate(cdeaths = cumsum(deaths), days.since = rank(cal.date, ties.method = "first")) %>%
  mutate(max.death=max(cdeaths)) %>%
  filter(cdeaths>10) %>%
  mutate(days.since = rank(cal.date, ties.method = "first")) 



df4$lab <- as.character(df4$countriesAndTerritories)
df4$lab[df4$countryterritoryCode=='USA'] <- 'USA'
df4$lab[df4$countryterritoryCode=='GBR'] <- 'UK'
df4$lab[df4$countryterritoryCode=='KOR'] <- 'South Korea'


df4$lab[df4$max.death<150] <- ''
df4$lab[df4$countryterritoryCode=='TUR'] <- 'Turkey'

df4$col <- 'no'
df4$col[df4$countryterritoryCode=='TUR'] <- 'yes'

max.n2 <- max(df4$days.since)



```

```{r g1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}





sc1 <- c(1,2,5,10,20,50,100,200,400,800,1500,3000,6000,10000,18000)
sc2 <- c(1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192)


#stat_smooth(aes(y = y1),method = "lm", formula = y ~ x + I(x^2), size = 1)


df2$country <- 'italya'
df2$country[df2$countryterritoryCode=='KOR'] <- 'güney kore'
df2$country[df2$countryterritoryCode=='ESP'] <- 'ispanya'
df2$country[df2$countryterritoryCode=='TUR'] <- 'türkiye'
df2$country[df2$countryterritoryCode=='USA'] <- 'abd'
df2$country[df2$countryterritoryCode=='GBR'] <- 'ingiltere'
df2$country[df2$countryterritoryCode=='DEU'] <- 'almanya'

pal <- c('#377eb8','#4daf4a','#984ea3','#ff7f00','#a65628','#f781bf','#e41a1c')

df.fit <- df2 %>%
  filter((countryterritoryCode)=="TUR" & cdeaths>20) %>%
  mutate(trend=days.since-3)

mo1 <-lm(data=df.fit, formula=log(cdeaths)~days.since)



g2 <- df2 %>% 
  ggplot(aes(x=days.since, y=log(cdeaths), group=country)) + 
  geom_abline(intercept = mo1$coefficients[1], slope = mo1$coefficients[2], colour='grey', linetype=2, size=2) +
  geom_line(aes(colour=country), size=1, alpha=1) + 
  geom_segment(aes(xend = max.n-1, yend = log(cdeaths), colour = country), linetype = 2) + 
  geom_point(size = 3,aes(colour=country)) + 
  geom_text(aes(x = max.n-1, label = country, colour=country), hjust = 0) + 
  theme(axis.title = element_text()) + 
  scale_color_manual(values = pal, guide=FALSE) +
  scale_y_continuous(breaks=c(log(sc1)), labels=sc1) +
  transition_reveal(days.since) + 
  coord_cartesian(clip = 'off') +
  labs(title= 'Koronavirüs (COVID-19) sebepli toplam can kaybı', 
  subtitle = 'ilk ölümden bu yana geçen süre : {frame_along} gün', x='',y='') +
  theme_fivethirtyeight() 


animate(g2,fps=5,height = 500, width =700,renderer = gifski_renderer(loop = F))






  



```
